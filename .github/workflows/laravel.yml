name: Laravel

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  laravel-ci:
    runs-on: ubuntu-latest

    steps:
    - name: Setup PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
    - name: Check out code
      uses: actions/checkout@v3
    - name: Install dependencies
      run: composer install --no-interaction --prefer-dist
    - name: Download PHP_CodeSniffer phars
      run: |
        curl -sSL https://squizlabs.github.io/PHP_CodeSniffer/phpcs.phar -o phpcs.phar
        curl -sSL https://squizlabs.github.io/PHP_CodeSniffer/phpcbf.phar -o phpcbf.phar
        chmod +x phpcs.phar phpcbf.phar
    - name: Run PHPCS
      run: |
        ./phpcs.phar --standard=PSR12 --extensions=php -n app/
    - name: Auto-fix with PHPCBF
      run: |
        ./phpcbf.phar --standard=PSR12 --extensions=php -n app/
    - name: Re-run PHPCS to ensure clean
      run: |
        ./phpcs.phar --standard=PSR12 --extensions=php -n app/
    - name: Copy .env
      run: php -r "file_exists('.env') || copy('.env.example', '.env');"
    - name: Install Dependencies
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist
    - name: Generate key
      run: php artisan key:generate
    - name: Directory Permissions
      run: chmod -R 777 storage bootstrap/cache
  deploy:
    name: ðŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Sync code to EC2 via rsync
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no -p ${EC2_SSH_PORT:-22} -i ${{ secrets.EC2_SSH_KEY }}" \
            --exclude '.git*' \
            --exclude 'vendor/' \
            --exclude '.env' \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/var/www/job-seek/

      - name: Run remote deploy commands
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_SSH_PORT || 22 }}
          script: |
            cd /var/www/job-seek
            composer install --no-dev --optimize-autoloader
            php artisan migrate --force
            php artisan config:cache
            php artisan route:cache
            php artisan queue:restart
